{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}
View recipe
{% endblock %}

{% block maincontent %}
<div class="row">

    <div class="col-md-4">
        {% if recipe.image_url %}
        <img src="{{ recipe.image_url }}" class="img-fluid w-100 rounded" alt="{{ recipe.name }}">
        {% endif %}

        <h1 class="mt-3 h2">{{ recipe.name }}</h1>
        <p><strong>Difficulty:</strong> {{ recipe.get_difficulty_display }}</p>
        <p><strong>Time needed:</strong> {{ recipe.time_needed|humanise_duration }}</p>
        <p><strong>Public:</strong> {{ recipe.public|yesno:"Yes,No" }}</p>

        {% if request.user == recipe.user %}
        <a class="btn btn-outline-secondary" href="{% url 'edit_recipe' recipe.id %}">Edit recipe</a>
        {% endif %}

    </div>

    <div class="col-md-8">

        <h2>Ingredients</h2>

        <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon1">Servings</span>
            <input type="number" class="form-control" id="servings" value="1" min="1" oninput="scaleIngredients()">
        </div>

        <table class="table table-light">
            <tbody>
                {% for ingredient in ingredients %}
                <tr>
                    <!-- Store the original measurement amount as a data attribute -->
                    <th data-original-amount="{{ ingredient.measurement_amount }}">
                        <span class="scaled-amount">{{ ingredient.measurement_amount }}</span>
                        {{ ingredient.ingredient.get_measurement_unit_display }}
                    </th>
                    <td>{{ ingredient.ingredient.name }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">No ingredients found for this recipe</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <script>
            function scaleIngredients() {
                // Get the number of servings from the input
                const servings = document.getElementById("servings").value;

                // Select all elements with the class "scaled-amount"
                const ingredients = document.querySelectorAll("th[data-original-amount]");

                ingredients.forEach((ingredient) => {
                    // Get the original amount from the data attribute
                    const originalAmount = parseFloat(ingredient.getAttribute("data-original-amount"));

                    // Calculate the new amount based on the servings
                    const scaledAmount = (originalAmount * servings).toFixed(2); // Limit to 2 decimal places

                    // Update the displayed amount
                    ingredient.querySelector(".scaled-amount").textContent = scaledAmount;
                });
            }
        </script>


        <h2>Method</h2>
        <p>{{ recipe.instructions|safe }}</p>

    </div>

</div>
{% endblock %}
{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
Create recipe
{% endblock %}

{% block maincontent %}
<div class="row">
    <div class="col-md-4">
        {% if recipe.image_url %}
        <img src="{{ recipe.image_url }}" class="img-fluid w-100 rounded" alt="{{ recipe.name }}">
        {% endif %}

        <h1 class="mt-3 h2">Edit Recipe: {{ recipe.name }}</h1>

        <h2 class="h4">Tags</h2>
        <ul id="tag-list" class="list-unstyled">
            {% for tag in recipe.tags.all %}
            <li>{{ tag.tag.name }}</li>
            {% empty %}
            <li>No tags found for this recipe</li>
            {% endfor %}
        </ul>

        <h2 class="h4">Add Tag</h2>
        <form id="tag-form" method="POST" hx-post="{% url 'add_tag' recipe.id %}" hx-target="#tag-list"
            hx-swap="beforeend">
            {% csrf_token %}
            <div class="input-group mb-3">
                <input type="text" name="name" class="form-control" placeholder="Tag Name" required>
                <button type="submit" class="btn btn-primary">Add Tag</button>
            </div>
        </form>
    </div>
    <div class="col-md-8">

        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane"
                    type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">Ingredients</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact-tab-pane"
                    type="button" role="tab" aria-controls="contact-tab-pane" aria-selected="false">Method
                    (TBC)</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane"
                    type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">Recipe info</button>
            </li>
        </ul>
        <div class="tab-content" id="myTabContent">
            <!-- Ingredients form -->
            <div class="tab-pane pt-3 fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab"
                tabindex="0">

                <div class="mb-4">
                    <p>For 1 serving</p>
                    <table class="table table-light">
                        <tbody id="ingredient-list">
                            {% for ingredient in recipe.recipe_ingredients.all %}
                            <tr id="ingredient-{{ ingredient.id }}">
                                <th>{{ingredient.measurement_amount}}
                                    {{ingredient.ingredient.get_measurement_unit_display}}
                                </th>
                                <td>{{ingredient.ingredient.name}}</td>
                                <td>
                                    <button hx-delete="{% url 'delete_ingredient' ingredient.id %}"
                                        hx-target="#ingredient-{{ ingredient.id }}" hx-swap="outerHTML"
                                        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                                        class="btn btn-outline-danger btn-sm">
                                        Remove
                                    </button>
                                </td>
                            </tr>

                            {% empty %}
                            <tr>
                                <td colspan="3" class="text-center">No ingredients found for this recipe</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="mb-5">
                    <h2 class="h5">Add Ingredient</h2>
                    <form id="ingredient-form" method="POST" hx-post="{% url 'add_ingredient' recipe.id %}"
                        hx-target="#ingredient-list" hx-swap="beforeend">
                        {% csrf_token %}
                        <div class="input-group mb-3">
                            <select name="ingredient" class="form-select" required>
                                <option value="">Select Ingredient</option>
                                {% for ingredient in ingredients %}
                                <option value="{{ ingredient.id }}">{{ ingredient.name }}
                                    ({{ingredient.get_measurement_unit_display}})</option>
                                {% endfor %}
                            </select>
                            <input type="number" name="measurement_amount" class="form-control" placeholder="Amount"
                                required>
                        </div>

                        <div class="input-group mb-3">
                            <button type="submit" class="btn btn-outline-secondary">Calculate</button>

                            <input type="number" name="calories" class="form-control" placeholder="Calories (kcal)"
                                required>
                            <input type="number" name="fat" class="form-control" placeholder="Fat (g)" required>
                            <input type="number" name="carbs" class="form-control" placeholder="Carbs (g)" required>
                            <input type="number" name="protein" class="form-control" placeholder="Protein (g)" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Ingredient</button>
                    </form>
                </div>

            </div>

            <!-- Method form -->
            <div class="tab-pane pt-3 fade" id="contact-tab-pane" role="tabpanel" aria-labelledby="contact-tab"
                tabindex="0">

                <h2 class="h3">Recipe method</h2>
                <form method="POST" class="form">
                    {% csrf_token %}
                    <input type="hidden" name="form_id" value="recipe_instructions">
                    {{ recipeinstructionsform|crispy }}
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <a href="{% url 'recipe_detail' recipe.id %}" class="btn btn-outline-danger">Cancel</a>
                </form>

            </div>

            <!-- Recipe form -->
            <div class="tab-pane pt-3 fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="profile-tab"
                tabindex="0">

                <h2 class="h3">Recipe info</h2>
                <form method="POST" class="form">
                    {% csrf_token %}
                    <input type="hidden" name="form_id" value="recipe_details">
                    {{ recipedetailsform|crispy }}
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <a href="{% url 'recipe_detail' recipe.id %}" class="btn btn-outline-danger">Cancel</a>
                </form>

            </div>

        </div>
    </div>
</div>

{% endblock %}